# API Gateway для Smart Home

API Gateway служит единой точкой входа для фронтенда и других внешних клиентов системы Smart Home. Он принимает REST/JSON запросы, преобразует их в gRPC-вызовы к внутренним микросервисам и отдаёт ответы в формате JSON.

## Основные возможности

- **Проксирование REST API → gRPC**: Преобразование REST запросов от фронтенда в gRPC-вызовы к внутренним микросервисам
- **WebSocket для обновлений в реальном времени**: Трансляция обновлений статусов устройств через WebSocket
- **JWT-аутентификация**: Проверка токенов доступа для защищённых эндпоинтов
- **Маршрутизация**: Все запросы маршрутизируются к соответствующим микросервисам

## Архитектура

API Gateway взаимодействует со следующими микросервисами:

- **Auth Service** (`:50051`): Аутентификация пользователей
- **Device Service** (`:50052`): Управление устройствами
- **Voice Service** (`:50053`): Обработка голосовых команд

## API Endpoints

### Публичные эндпоинты (без аутентификации)

- `GET /health` - Проверка работоспособности сервиса
- `GET /ws/status` - WebSocket-соединение для получения обновлений статусов устройств
- `POST /api/v1/auth/login` - Аутентификация пользователя (получение JWT)
- `POST /api/v1/auth/refresh` - Обновление токена доступа

### Защищённые эндпоинты (требуют JWT)

- `GET /api/v1/devices` - Получение списка устройств
- `GET /api/v1/devices/{id}` - Получение информации об устройстве
- `POST /api/v1/devices/{id}/control` - Отправка команды на устройство
- `POST /api/v1/voice` - Отправка голосовой команды

### Отладочные эндпоинты

- `POST /debug/token` - Генерация тестового JWT (только для разработки)

## WebSocket API

Клиенты могут подключаться к WebSocket-эндпоинту `/ws/status` для получения обновлений в реальном времени. 
После установки соединения клиент автоматически получает уведомления об изменении статусов всех устройств.

Формат сообщения:
```json
{
  "device_id": "device123",
  "status": {
    "online": true,
    "parameters": {
      "power": "on",
      "brightness": "75"
    },
    "battery_level": 95,
    "signal_strength": 0.85
  },
  "time": "2023-06-15T14:22:36.123456Z"
}
```

## Запуск локально

API Gateway можно запустить локально с помощью команды:

```bash
go run cmd/gateway/main.go
```

## Конфигурация

Основные настройки API Gateway можно передать через флаги командной строки:

```
--port              - HTTP-порт (по умолчанию 8080)
--auth-service      - Адрес Auth Service (по умолчанию localhost:50051)
--device-service    - Адрес Device Service (по умолчанию localhost:50052)
--voice-service     - Адрес Voice Service (по умолчанию localhost:50053)
```

## Docker

Сборка Docker-образа:

```bash
docker build -t smarthome-api-gateway .
```

Запуск через Docker Compose:

```bash
docker-compose up -d
```

## Статус реализации

- [x] `GET /health` → `200 OK` - реализовано
- [x] `POST /api/v1/auth/login` → JWT токен - реализовано
- [x] `GET /api/v1/devices` → JSON-массив устройств - реализовано
- [x] `POST /api/v1/devices/{id}/control` → управление устройством - реализовано
- [x] `/ws/status` → обновления статусов устройств в реальном времени - реализовано
- [x] Интеграция с фронтендом - конфигурация прокси в Vite настроена

## Дальнейшие улучшения

- [ ] Добавление метрик Prometheus
- [ ] Расширенное логирование запросов
- [ ] Добавление трассировки с OpenTelemetry
- [ ] Реализация rate-limiting для защиты API
- [ ] Кэширование часто запрашиваемых данных 