# API Gateway

API Gateway служит единой точкой входа для внешних клиентов системы Smart-Home. Он обеспечивает трансляцию внешних REST-запросов в gRPC-вызовы внутренних микросервисов, а также предоставляет WebSocket-соединения для обновлений в реальном времени.

## Основные компоненты

1. **HTTP-сервер с REST API**
   - Обеспечивает REST-интерфейс для внешних клиентов
   - Преобразует REST-запросы в gRPC с помощью gRPC-gateway
   - Реализует JWT-аутентификацию для защиты API

2. **WebSocket-сервер**
   - Предоставляет канал связи для обновлений в реальном времени
   - Отправляет уведомления об изменении статусов устройств
   - Реализует простую эхо-функциональность для тестирования

3. **Интеграция с Kafka**
   - Подписка на топик `statusChanged` для получения обновлений статусов устройств
   - Асинхронная обработка сообщений и маршрутизация на WebSocket-клиентов

4. **gRPC-клиенты**
   - Соединения с внутренними микросервисами:
     - Auth Service (аутентификация)
     - Device Service (управление устройствами)
     - Voice Service (голосовое управление)

## Структура protobuf

API Gateway использует сгенерированные protobuf-файлы для взаимодействия с внутренними сервисами. Все определения API находятся в proto-файлах и сгенерированном на их основе коде:

- `proto/smarthome/v1/*.proto` - Описания сервисов (auth.proto, device.proto, voice.proto)
- `proto/smarthome/v1/common/*.proto` - Общие типы данных, используемые несколькими сервисами
- `services/api-gateway/proto/` - Сгенерированный Go код для сервисов
- `services/api-gateway/proto/openapiv2/` - Сгенерированная OpenAPI документация
- `proto_generated/` - Общие сгенерированные типы данных, используемые всеми сервисами

## API-эндпоинты

### Аутентификация

- `POST /api/v1/auth/login` - Аутентификация пользователя
- `POST /api/v1/auth/logout` - Выход из системы
- `POST /api/v1/auth/refresh` - Обновление JWT-токена

### Устройства

- `GET /api/v1/devices` - Получение списка устройств
- `GET /api/v1/devices/{id}` - Получение информации об устройстве
- `POST /api/v1/devices/{id}/control` - Отправка команды на устройство

### Голосовое управление

- `POST /api/v1/voice` - Обработка голосовой команды

### Служебные эндпоинты

- `GET /health` - Проверка статуса сервиса
- `GET /ws` - WebSocket-соединение
- `POST /debug/token` - Генерация тестового JWT (только для разработки)

## Механизм обновления токенов

API Gateway поддерживает механизм автоматического обновления JWT-токенов:

1. Клиент получает `access_token` и `refresh_token` при аутентификации
2. При истечении срока действия `access_token`, клиент получает ошибку 401 Unauthorized
3. Клиент отправляет `refresh_token` на эндпоинт `/api/v1/auth/refresh`
4. Сервер проверяет валидность `refresh_token` и возвращает новую пару токенов
5. Клиент обновляет свои токены и повторяет исходный запрос

Для веб-приложений реализован интерсептор, который автоматически обновляет токены при получении ошибки 401.

## WebSocket API

Клиенты могут подключаться к WebSocket-эндпоинту `/ws` для получения обновлений в реальном времени. В текущей версии реализована эхо-функциональность, в будущем будет реализована отправка обновлений статусов устройств.

## Запуск локально

API Gateway можно запустить локально с помощью команды:

```bash
make run-gateway
```

По умолчанию сервер запускается на порту 8080.

## Конфигурация

Основные настройки API Gateway можно передать через флаги командной строки:

```
--port              - HTTP-порт (по умолчанию 8080)
--auth-service      - Адрес Auth Service (по умолчанию localhost:50051)
--device-service    - Адрес Device Service (по умолчанию localhost:50052)
--voice-service     - Адрес Voice Service (по умолчанию localhost:50053)
--kafka-brokers     - Адрес Kafka брокера (по умолчанию localhost:9092)
--kafka-topic       - Kafka топик (по умолчанию statusChanged)
```

## Безопасность

API Gateway реализует JWT-аутентификацию для защиты API-эндпоинтов. Все запросы, кроме публичных (`/health`, `/api/v1/auth/login`, `/api/v1/auth/refresh`), требуют валидный JWT-токен в заголовке Authorization. 

Refresh-токены имеют более длительный срок жизни, чем access-токены, и используются только для получения новых access-токенов. При выходе из системы (через `/api/v1/auth/logout`) оба токена отзываются. 